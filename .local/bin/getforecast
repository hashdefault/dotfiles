#!/bin/bash

# Put in your api and stuff link here
# If you dunno, head to openweathermap.org, and make and account
#(completely free I swear, and then get your API Key and  your City ID)
# I wish I was smart enough to do it like Elena, but this is the top I could do lol
KEY="60ef916f5fec2a35d4d47fe458167df9"
UNIT="metric" #Options are 'metric' and 'imperial'
LAT='-23.4166'
LON='-51.9365'

# Declare associative array
declare -A weather_desc

# Individual codes
weather_desc[0]="Clear Sky"
weather_desc[1]="Mainly Clear"
weather_desc[2]="Partly Cloudy"
weather_desc[3]="Overcast"
weather_desc[45]="Fog"
weather_desc[48]="Fog"
weather_desc[51]="Drizzle"
weather_desc[53]="Drizzle"
weather_desc[55]="Drizzle"
weather_desc[56]="Freezing Drizzle"
weather_desc[57]="Freezing Drizzle"
weather_desc[61]="Rain"
weather_desc[63]="Rain"
weather_desc[65]="Rain"
weather_desc[66]="Freezing Rain"
weather_desc[67]="Freezing Rain"
weather_desc[71]="Snowfall"
weather_desc[73]="Snowfall"
weather_desc[75]="Snowfall"
weather_desc[77]="Snow Grains"
weather_desc[80]="Rain Showers"
weather_desc[81]="Rain Showers"
weather_desc[82]="Rain Showers"
weather_desc[85]="Snow Showers"
weather_desc[86]="Snow showers"
weather_desc[95]="Thunderstorm"
weather_desc[96]="Thunderstorm with Hail"
weather_desc[99]="Thunderstorm with Hail"

declare -A weather_icons
#case $code in
#0) desc="Clear sky" ;;
#[1-3]) desc="Mainly clear/partly cloudy/overcast" ;;
#45 | 48) desc="Fog" ;;
#51 | 53 | 55) desc="Drizzle" ;;
#56 | 57) desc="Freezing drizzle" ;;
#61 | 63 | 65) desc="Rain" ;;
#66 | 67) desc="Freezing rain" ;;
#71 | 73 | 75) desc="Snowfall" ;;
#77) desc="Snow grains" ;;
#80 | 81 | 82) desc="Rain showers" ;;
#85 | 86) desc="Snow showers" ;;
#95) desc="Thunderstorm" ;;
#96 | 99) desc="Thunderstorm with hail" ;;
#*) desc="Unknown" ;;
#esac
weather_icons["0"]=" "
weather_icons["1"]=" "
weather_icons["2"]=" "
weather_icons["3"]=" "
weather_icons["45"]="󰖑 "
weather_icons["48"]="󰖑 "
#weather_icons["45"]=" "
#weather_icons["48"]=" "
weather_icons["51"]=" "
weather_icons["53"]=" "
weather_icons["55"]=" "
weather_icons["56"]="󰙿 "
weather_icons["57"]="󰙿 "
weather_icons["61"]=" "
weather_icons["63"]=" "
weather_icons["66"]="󰙿 "
weather_icons["67"]="󰙿 "
weather_icons["71"]=" "
weather_icons["73"]=" "
weather_icons["75"]=" "
weather_icons["77"]="󰼶 "
weather_icons["80"]=" "
weather_icons["81"]=" "
weather_icons["82"]=" "
weather_icons["85"]=" "
weather_icons["86"]=" "
weather_icons["95"]=" "
weather_icons["96"]=" "
weather_icons["99"]=" "
#weather_icons["13d"]=" "

declare -A weather_colors

weather_colors["0"]="#ffd86b"
weather_colors["1"]="#ffd86b"
weather_colors["2"]="#fcdcf6"
weather_colors["3"]="#fcdcf6"
weather_colors["45"]="#adadff"
weather_colors["48"]="#adadff"
#weather_colors["45"]=" "
#weather_colors["48"]=" "
weather_colors["51"]="#6b95ff"
weather_colors["53"]="#6b95ff"
weather_colors["55"]="#6b95ff"
weather_colors["56"]="#6b95ff"
weather_colors["57"]="#6b95ff"
weather_colors["61"]="#6b95ff"
weather_colors["63"]="#6b95ff"
weather_colors["66"]="#6b95ff"
weather_colors["67"]="#6b95ff"
weather_colors["71"]="#84afdb"
weather_colors["73"]="#84afdb"
weather_colors["75"]="#84afdb"
weather_colors["77"]="#84afdb"
weather_colors["80"]="#365bed"
weather_colors["81"]="#365bed"
weather_colors["82"]="#365bed"
weather_colors["85"]="#84afdb"
weather_colors["86"]="#84afdb"
weather_colors["95"]="#365bed"
weather_colors["96"]="#365bed"
weather_colors["99"]="#365bed"
#weather_colors["13d"]=" "

#curl -sf "https://api.openweathermap.org/data/3.0/onecall/?lat=$LAT&lon=$LON&exclude=hourly,minutely,alerts&units=$UNIT&appid=$KEY" -o /tmp/forecast_call.json
curl -sf "https://api.open-meteo.com/v1/forecast?latitude=-23.4253&longitude=-51.9386&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max&timezone=America%2FSao_Paulo" -o /tmp/forecast_call.json

day=1
index=0
for key in $(jq -c '.daily.time | keys | .[]' /tmp/forecast_call.json); do
  temp_max=$(jq -r ".daily.temperature_2m_max[$key]" /tmp/forecast_call.json | cut -d '.' -f 1)
  temp_min=$(jq -r ".daily.temperature_2m_min[$key]" /tmp/forecast_call.json | cut -d '.' -f 1)

  icon=$(jq -r ".daily.weather_code[$key]" /tmp/forecast_call.json)
  prec=$(jq -r ".daily.precipitation_probability_max[$key]" /tmp/forecast_call.json)
  weather_code=$(jq -r ".daily.weather_code[$key]" /tmp/forecast_call.json)
  desc=$(echo "${weather_desc[$weather_code]}" | sed 's/\b\(.\)/\u\1/g')

  datetime=$(jq -r ".daily.time[$key]" /tmp/forecast_call.json)
  weekday=$(date -d "$datetime" '+%A')

  echo "󰖌 $prec%" >"/tmp/forecast_${day}day_prec"
  echo "$weekday" >"/tmp/getweatherweekday${day}"
  echo "${weather_colors[$icon]}" >"/tmp/forecast_${day}day_prec_color"
  echo "$temp_min/$temp_max °C" >"/tmp/forecast_${day}day_temp"
  echo "${weather_icons[$icon]}" >"/tmp/forecast_${day}day_icon"
  echo "${weather_colors[$icon]}" >"/tmp/forecast_${day}day_icon_color"
  echo "$desc" >"/tmp/forecast_${day}day_desc"
  day=$((day + 1))
  index=$((index + 1))
done
